<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>拡張アクション: Grok Wars</title>
    <style>
        body { margin: 0; background: black; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #title {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white; text-align: center;
            overflow-y: auto; padding: 10px; box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center; z-index: 10;
        }
        #title h1 { font-size: 24px; margin: 10px 0; }
        #title p { font-size: 16px; margin: 5px 0; }
        .slider-container { width: 90%; margin: 8px 0; }
        .slider { width: 70%; vertical-align: middle; }
        .label { font-size: 14px; display: inline-block; width: 120px; text-align: left; }
        #startBtn {
            position: sticky; bottom: 10px; padding: 15px 30px; font-size: 18px;
            background: #00f; border: none; color: white; border-radius: 5px; cursor: pointer;
        }
        #startBtn:hover { background: #005; }
        #guide {
            position: absolute; top: 10px; left: 10px; color: white; font-size: 14px;
            background: rgba(0,0,0,0.5); padding: 8px; border-radius: 5px;
        }
        #title::-webkit-scrollbar { width: 10px; }
        #title::-webkit-scrollbar-thumb { background: #666; border-radius: 5px; }
        #title::-webkit-scrollbar-track { background: #333; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="title">
        <h1>拡張アクション: Grok Wars</h1>
        <p>操作: 左スライダーをドラッグで移動＆方向変更、自動で攻撃＆アイテム吸い寄せ</p>
        <div class="slider-container">
            <label class="label">難易度:</label>
            <input type="range" id="difficulty" min="1" max="5" value="3" class="slider">
            <span id="diffVal">3</span>
        </div>
        <div class="slider-container">
            <label class="label">移動速度:</label>
            <input type="range" id="playerSpeed" min="1" max="10" value="5" class="slider">
            <span id="speedVal">5</span>
        </div>
        <div class="slider-container">
            <label class="label">初期ライフ:</label>
            <input type="range" id="initialLife" min="3" max="10" value="5" class="slider">
            <span id="lifeVal">5</span>
        </div>
        <div class="slider-container">
            <label class="label">敵出現数:</label>
            <input type="range" id="enemySpawn" min="5" max="20" value="10" class="slider">
            <span id="spawnVal">10</span>
        </div>
        <div class="slider-container">
            <label class="label">アイテム耐久:</label>
            <input type="range" id="itemDur" min="10" max="50" value="20" class="slider">
            <span id="itemDurVal">20</span>
        </div>
        <div class="slider-container">
            <label class="label">敵耐久倍率:</label>
            <input type="range" id="enemyDurMul" min="0.5" max="2" step="0.1" value="1" class="slider">
            <span id="enemyDurVal">1</span>
        </div>
        <div class="slider-container">
            <label class="label">攻撃力:</label>
            <input type="range" id="attackPower" min="1" max="5" value="2" class="slider">
            <span id="atkVal">2</span>
        </div>
        <div class="slider-container">
            <label class="label">BGM音量:</label>
            <input type="range" id="bgmVol" min="0" max="1" step="0.1" value="0.5" class="slider">
            <span id="volVal">0.5</span>
        </div>
        <div class="slider-container">
            <label class="label">スコア倍率:</label>
            <input type="range" id="scoreMul" min="1" max="3" value="1" class="slider">
            <span id="scoreVal">1</span>
        </div>
        <div class="slider-container">
            <label class="label">操作感度:</label>
            <input type="range" id="joySens" min="0.5" max="2" step="0.1" value="1" class="slider">
            <span id="joyVal">1</span>
        </div>
        <div class="slider-container">
            <label class="label">敵速度倍率:</label>
            <input type="range" id="enemySpeedMul" min="0.5" max="2" step="0.1" value="0.5" class="slider">
            <span id="enemySpeedVal">0.5</span>
        </div>
        <div class="slider-container">
            <label class="label">ボス耐久倍率:</label>
            <input type="range" id="bossDurMul" min="0.5" max="2" step="0.1" value="0.5" class="slider">
            <span id="bossDurVal">0.5</span>
        </div>
        <button id="startBtn" onclick="startGame()">スタート</button>
    </div>
    <div id="guide" style="display: none;">左スライダー: 移動＆方向変更 / 自動攻撃＆アイテム吸い寄せ</div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            console.log(`Screen: ${width}x${height}`);
        }
        resize();
        window.addEventListener('resize', resize);

        let params = {};
        function updateSliderLabels() {
            document.getElementById('diffVal').textContent = document.getElementById('difficulty').value;
            document.getElementById('speedVal').textContent = document.getElementById('playerSpeed').value;
            document.getElementById('lifeVal').textContent = document.getElementById('initialLife').value;
            document.getElementById('spawnVal').textContent = document.getElementById('enemySpawn').value;
            document.getElementById('itemDurVal').textContent = document.getElementById('itemDur').value;
            document.getElementById('enemyDurVal').textContent = document.getElementById('enemyDurMul').value;
            document.getElementById('atkVal').textContent = document.getElementById('attackPower').value;
            document.getElementById('volVal').textContent = document.getElementById('bgmVol').value;
            document.getElementById('scoreVal').textContent = document.getElementById('scoreMul').value;
            document.getElementById('joyVal').textContent = document.getElementById('joySens').value;
            document.getElementById('enemySpeedVal').textContent = document.getElementById('enemySpeedMul').value;
            document.getElementById('bossDurVal').textContent = document.getElementById('bossDurMul').value;
        }
        updateSliderLabels();
        ['difficulty', 'playerSpeed', 'initialLife', 'enemySpawn', 'itemDur', 'enemyDurMul', 'attackPower', 'bgmVol', 'scoreMul', 'joySens', 'enemySpeedMul', 'bossDurMul'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateSliderLabels);
        });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBGM(vol) {
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = vol;
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            return oscillator;
        }
        function playItemSound() {
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(params.bgmVol, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }
        let bgm;

        let player, enemies = [], items = [], score = 0, gameOver = false, cleared = false;
        let moveTouch = { id: null, x: 0, y: 0, active: false };
        let wave = 0;

        class Entity {
            constructor(x, y, size, color, dur) {
                this.x = x; this.y = y; this.size = size; this.color = color; this.dur = dur; this.maxDur = dur; this.scale = 1;
                this.blink = 0;
                this.baseColor = color;
            }
            updateScale() {
                this.scale = this.dur / this.maxDur;
                const alpha = Math.floor(this.scale * 255).toString(16).padStart(2, '0');
                this.color = this.baseColor + alpha; // 例: 'red' は '#ff0000' だが、簡易的にRGBAとして扱う (実際のcolorは'#ff0000ff'形式に調整可能)
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(this.scale, this.scale);
                ctx.fillStyle = this.color;
                if (this.isItem) {
                    ctx.globalAlpha = 0.7 + 0.3 * Math.sin(this.blink);
                    this.blink += 0.1;
                }
                ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                if (this.type === 0 && !this.isItem) {
                    ctx.strokeStyle = 'yellow';
                    ctx.strokeRect(-this.size/2-2, -this.size/2-2, this.size+4, this.size+4);
                }
                ctx.globalAlpha = 1;
                ctx.restore();
            }
        }

        class Player extends Entity {
            constructor() {
                super(width/2, height/2, 30, '#0000ff', params.initialLife * 10); // blue as #0000ff
                this.angle = 0; this.speed = params.playerSpeed;
                this.extensions = []; this.attack = params.attackPower;
            }
            update() {
                const dx = moveTouch.x - width/4, dy = moveTouch.y - (height-150);
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (moveTouch.active && dist > 20) {
                    this.x += (dx / dist) * this.speed * params.joySens;
                    this.y += (dy / dist) * this.speed * params.joySens;
                    this.angle = Math.atan2(dy, dx);
                }
                this.x = Math.max(0, Math.min(width, this.x));
                this.y = Math.max(0, Math.min(height, this.y));
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                let extX = this.size/2;
                this.extensions.forEach(ext => {
                    ctx.fillStyle = ext.color;
                    ctx.fillRect(extX, -ext.size/2, ext.size, ext.size);
                    extX += ext.size;
                });
                ctx.strokeStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(this.size/2, 0);
                ctx.lineTo(this.size/2 + this.extensions.reduce((a, e) => a + e.size, 0) + 20, 0);
                ctx.stroke();
                ctx.restore();
            }
            attackEnemies() {
                const frontX = this.x + Math.cos(this.angle) * (this.size/2 + this.extensions.reduce((a, e) => a + e.size, 0));
                const frontY = this.y + Math.sin(this.angle) * (this.size/2 + this.extensions.reduce((a, e) => a + e.size, 0));
                enemies.forEach(e => {
                    const dist = Math.hypot(e.x - frontX, e.y - frontY);
                    if (dist < (e.size + this.size)/2) {
                        e.dur -= this.attack
